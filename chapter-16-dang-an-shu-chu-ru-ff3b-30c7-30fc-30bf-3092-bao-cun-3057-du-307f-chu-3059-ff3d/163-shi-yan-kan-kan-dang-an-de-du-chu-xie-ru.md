檔案要可以讀取寫入才會有用，所以剛剛就都說明了。那麼，就用範例程式來實驗關於檔案的讀取寫入吧。

### 寫出可以寫入跟讀出的程式

這次，我們分別寫讀出程式跟寫入程式。先是寫入程式:

**source code**
*fwrite_test.c*
```cpp
#include <stdio.h>

#define FILE_NAME "test.dat"

int main(){

	int array[16] = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16};

	size_t write_num;
	FILE *fp;

	fp = fopen(FILE_NAME, "w");
	if(fp == NULL){
		printf("Can't create file\n'");
		return -1;
	}

	write_num = fwrite(array, sizeof(int), 16, fp);
	if(write_num != 16){
		printf("Error\n");
		fclose(fp);
		return -1;
	}

	printf("fwrite complete\n");

	fclose(fp);

	return 0;
}
```
再來是讀出的程式:

**source code**
*fread_test.c*
```cpp
#include <stdio.h>

#define FILE_NAME "test.dat"

int main(){

	int array[16];
	int i;

	size_t read_num;
	FILE *fp;

	fp = fopen(FILE_NAME, "r");
	if(fp == NULL){
		printf("Can't open file\n'");
		return -1;
	}

	read_num = fread(array, sizeof(int), 16, fp);
	if(read_num != 16){
		if(feof(fp)){
			printf("End of file\n");
		}
		else if(ferror(fp)){
			printf("Error\n");
		}
		fclose(fp);
		return -1;
	}

	for(i = 0; i < 16; i++){//>
		printf("%d ", array[i]);
	}
	printf("\nfread complete\n");

	fclose(fp);

	return 0;
}
```
**執行結果:**
```
$ ./fwrite_test 
fwrite complete
$ ./fread_test 
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 
fread complete
```
如何呢? 至今為止的範例程式都是每次實行過後結果就不會留下來了，如果是當作檔案來處理的話就可以留下結果。很高興吧。

### 文字檔案跟binary file

如果我們嘗試以文字檔打開剛剛的test.dat的話，可能會發現它長這樣(筆者的電腦根本開不起來):

*test.dat*
```
^A^@^@^@^B^@^@^@^C^@^@^@^D^@^@^@^E^@^@^@^F^@^@^@^G^@^@^@^H^@^@^@   ^@^@^@^@^@^@^K^@^@^@^L^@^@^@^M^@^@^@^N^@^@^@^O^@^@^@^P^@^@^@
```
不會想到這是放著1,2,3...的檔案吧。這是因為我們把**int**的資料直接寫進去。^@在許多的編輯器都是顯示成0，^A則是代表數字1的記號。也就是說^A^@^@^@代表的是01 00 00 00，也就是little endian的數字1。

像這種人們看不懂的檔案我們叫binary file。像MS-DOS或Windows這種明確區分文字檔案跟binary file的OS，如果範例程式的執行不符合上面的執行結果的話，可以把r,w換成rb,wb。"b"是要OS確實的把它當binary file來處理。

難得學會了檔案的處理，兼做複習，把第15章的address.c的範例程式輸入的資料把它輸出成檔案吧。只要把**delete_all()**改成像下面這樣就可以了。

```cpp
void delete_all (void){

    struct tag_address *ptr_now, *ptr_before;
	FILE *fp;
    size_t write_size;
    
    ptr_now = address;
    fp = fopen("address.dat", "w");
	if(fp == NULL){
		printf("Can't create file\n'");
	}

    while(ptr_now != NULL){
    	if(fp != NULL){
        	write_size = fwrite(ptr_now, sizeof(struct tag_address), 1, fp);
            if(write_size != 1){
            	printf("Error\n");
            }
        }
        ptr_before = ptr_now;
        ptr_now = ptr_now -> next;
        free(ptr_before);
    }
    if(fp != NULL){
    	fclose(fp);
    }
}

```
經由這樣的改造，可以輸出address.dat。

*address.dat*
```
\00\00\00Motaki Taneda\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00Tokyo\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00P
\00\00\00\00\00\00\00Shuwa System\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00Minaku\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\90
\00\00\00\00\00\00\00Taro Nippon\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00Japan\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00
```

要讀入這個的話，就只要在程式啟動時做一個linked list就可以了。雖然有些難，加油把**enter()**函數改一改吧。要注意的是，這次的**delete_all()**也寫了指標。但是這個指標對讀取造成阻礙，請無視。

**恐怖實驗: resource leak**

搞懂了檔案的處理方法，來實驗看看resource leak吧。如果**fopen()**的話，就要**fclose()**，違反了這原則會如何呢?

**source code**
*resource_leak.c*
```cpp
#include <stdio.h>

#define FILE_NAME "test.dat"

int main(){

	int i;
	FILE *fp;

	for(i = 1; i < 8192; i++){//>
		fp = fopen(FILE_NAME, "r");
		if(fp == NULL){
			printf("Can't open the file\n");
			return -1;
		}
		printf("%d file opened.\n", i);
	}

	return 0;
}
```
**執行結果:**
```
1 file opened.
2 file opened.
3 file opened.
4 file opened.
5 file opened.
6 file opened.
7 file opened.
......
1007 file opened.
1008 file opened.
1009 file opened.
1010 file opened.
1011 file opened.
1012 file opened.
1013 file opened.
1014 file opened.
1015 file opened.
1016 file opened.
1017 file opened.
1018 file opened.
1019 file opened.
1020 file opened.
1021 file opened.
Can't open the file
```
可以發現開到第1021個file時出現錯誤。不過會受到開不起來的影響的，只有這個程式。如果是UNIX的話，利用super user(root)權限的話可以做特殊的設定來開更多，但是開太多的話，系統還是有它的上限。這樣的話就會影響到其他程式，變成預想不到的事態。所以要記得，跟記憶體一樣，**fopen()**的話一定要**fclose()**。